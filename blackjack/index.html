<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>霓虹21點 — NEON BLACKJACK</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root{--cyan:#00f0ff;--magenta:#ff2d95;--violet:#b026ff;--gold:#ffd700;--dark:#0a0a1a;--glass:rgba(255,255,255,.04);--green:#00c853;--red:#ff3d3d}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans TC',sans-serif;background:var(--dark);color:#e0e0f0;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:16px;overflow-x:hidden}
        body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 600px 400px at 30% 20%,rgba(0,240,255,.05) 0%,transparent 70%),radial-gradient(ellipse 500px 500px at 70% 80%,rgba(255,45,149,.04) 0%,transparent 70%);z-index:0}
        body::after{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,240,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,240,255,.02) 1px,transparent 1px);background-size:60px 60px;z-index:0;pointer-events:none}
        .container{max-width:520px;width:100%;position:relative;z-index:1}

        h1{font-family:'Orbitron',sans-serif;font-weight:900;font-size:1.8rem;letter-spacing:4px;text-align:center;background:linear-gradient(135deg,var(--cyan),var(--magenta));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 20px rgba(0,240,255,.3));text-transform:uppercase}
        .subtitle{font-family:'Orbitron',sans-serif;font-size:.6rem;letter-spacing:5px;text-align:center;color:rgba(255,255,255,.3);margin:4px 0 14px;text-transform:uppercase}

        /* Top bar */
        .top-bar{display:flex;justify-content:space-between;align-items:center;background:var(--glass);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px 18px;margin-bottom:14px;backdrop-filter:blur(20px)}
        .tb-item{text-align:center}
        .tb-label{font-family:'Orbitron',sans-serif;font-size:.5rem;letter-spacing:2px;color:rgba(255,255,255,.3);text-transform:uppercase}
        .tb-value{font-family:'Orbitron',sans-serif;font-size:1.3rem;font-weight:700}
        .tb-credits{color:var(--gold);text-shadow:0 0 10px rgba(255,215,0,.3)}
        .tb-bet{color:var(--cyan)}
        .tb-record{color:var(--green);font-size:1rem}

        /* Game table */
        .table{background:linear-gradient(180deg,#0d1a0d 0%,#0a120a 100%);border:1.5px solid rgba(0,200,80,.15);border-radius:20px;padding:20px 16px;margin-bottom:14px;position:relative;box-shadow:0 0 40px rgba(0,200,80,.06),inset 0 0 60px rgba(0,0,0,.5);min-height:360px}
        .table::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,200,80,.3),transparent)}

        /* Hand area */
        .hand-area{margin-bottom:20px;min-height:130px}
        .hand-label{font-family:'Orbitron',sans-serif;font-size:.55rem;letter-spacing:2px;color:rgba(255,255,255,.3);text-transform:uppercase;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
        .hand-score{font-family:'Orbitron',sans-serif;font-size:.9rem;font-weight:700;color:var(--cyan);padding:2px 10px;background:rgba(0,240,255,.08);border-radius:100px;border:1px solid rgba(0,240,255,.15)}
        .hand-score.bust{color:var(--red);background:rgba(255,60,60,.08);border-color:rgba(255,60,60,.15)}
        .hand-score.bj{color:var(--gold);background:rgba(255,215,0,.08);border-color:rgba(255,215,0,.15)}

        .cards-row{display:flex;gap:8px;flex-wrap:wrap;min-height:100px;align-items:flex-end}

        /* Card */
        .card{
            width:70px;height:100px;border-radius:10px;
            position:relative;
            transform-style:preserve-3d;
            transition:transform .5s cubic-bezier(.4,0,.2,1);
            cursor:default;flex-shrink:0;
        }
        .card.enter{animation:cardDeal .4s ease-out forwards}
        @keyframes cardDeal{from{opacity:0;transform:translateY(-30px) scale(.8) rotateY(180deg)}to{opacity:1;transform:translateY(0) scale(1) rotateY(0)}}
        .card.face-down{transform:rotateY(180deg)}
        .card.face-down.reveal{animation:cardReveal .5s ease-out forwards}
        @keyframes cardReveal{from{transform:rotateY(180deg)}to{transform:rotateY(0)}}

        .card-face,.card-back-face{
            position:absolute;width:100%;height:100%;
            backface-visibility:hidden;-webkit-backface-visibility:hidden;
            border-radius:10px;display:flex;flex-direction:column;
            align-items:center;justify-content:center;
        }
        .card-face{
            background:linear-gradient(160deg,#1a1a3a,#10102a);
            border:1.5px solid rgba(255,255,255,.12);
            box-shadow:0 4px 15px rgba(0,0,0,.4);
        }
        .card-back-face{
            transform:rotateY(180deg);
            background:linear-gradient(135deg,#1a0a2e,#0a0a1e);
            border:1.5px solid rgba(176,38,255,.2);
            box-shadow:0 4px 15px rgba(0,0,0,.4);
        }
        .card-back-pattern{
            width:50px;height:70px;border:1.5px solid rgba(176,38,255,.15);
            border-radius:6px;display:flex;align-items:center;justify-content:center;
        }
        .card-back-pattern::after{content:'♠';font-size:1.2rem;color:rgba(176,38,255,.2)}

        .card-rank{font-family:'Orbitron',sans-serif;font-size:1.4rem;font-weight:700;line-height:1}
        .card-suit{font-size:1.6rem;margin-top:2px}
        .card-corner{position:absolute;top:4px;left:6px;font-size:.55rem;font-family:'Orbitron',sans-serif;font-weight:700;line-height:1.1}
        .card-corner-suit{font-size:.7rem}
        .card-red{color:#ff4060}
        .card-black{color:#e0e0f0}

        /* Divider */
        .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);margin:8px 0}

        /* Result message */
        .result-msg{
            text-align:center;font-family:'Orbitron',sans-serif;
            font-size:1.1rem;font-weight:700;letter-spacing:2px;
            min-height:36px;display:flex;align-items:center;justify-content:center;
            margin:10px 0;
        }
        .result-msg.win{color:var(--gold);text-shadow:0 0 15px rgba(255,215,0,.4)}
        .result-msg.lose{color:var(--red)}
        .result-msg.push{color:rgba(255,255,255,.5)}
        .result-msg.blackjack{color:var(--gold);font-size:1.4rem;animation:bjPulse 1s ease-in-out infinite alternate}
        @keyframes bjPulse{to{text-shadow:0 0 25px rgba(255,215,0,.6);transform:scale(1.05)}}

        /* Controls */
        .controls{display:flex;flex-direction:column;gap:10px;align-items:center;margin-bottom:14px}
        .bet-phase,.play-phase{display:flex;flex-direction:column;gap:10px;align-items:center;width:100%}
        .play-phase{display:none}
        .chip-row{display:flex;gap:6px;align-items:center}
        .chip-label{font-family:'Orbitron',sans-serif;font-size:.55rem;letter-spacing:2px;color:rgba(255,255,255,.3);text-transform:uppercase}
        .chip{
            width:48px;height:48px;border-radius:50%;
            display:flex;align-items:center;justify-content:center;
            font-family:'Orbitron',sans-serif;font-size:.65rem;font-weight:700;
            cursor:pointer;transition:all .3s;position:relative;
            border:2.5px solid;
        }
        .chip::before{content:'';position:absolute;inset:3px;border-radius:50%;border:1.5px dashed;opacity:.3}
        .chip-10{background:rgba(0,240,255,.1);border-color:var(--cyan);color:var(--cyan)}
        .chip-10::before{border-color:var(--cyan)}
        .chip-50{background:rgba(176,38,255,.1);border-color:var(--violet);color:var(--violet)}
        .chip-50::before{border-color:var(--violet)}
        .chip-100{background:rgba(255,45,149,.1);border-color:var(--magenta);color:var(--magenta)}
        .chip-100::before{border-color:var(--magenta)}
        .chip-500{background:rgba(255,215,0,.1);border-color:var(--gold);color:var(--gold)}
        .chip-500::before{border-color:var(--gold)}
        .chip:hover{transform:translateY(-4px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
        .chip:active{transform:scale(.95)}

        .btn-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
        .btn{
            font-family:'Orbitron',sans-serif;font-size:.7rem;font-weight:700;
            letter-spacing:2px;text-transform:uppercase;padding:14px 28px;
            border:none;border-radius:100px;cursor:pointer;transition:all .3s;
        }
        .btn:hover{transform:translateY(-2px)}
        .btn:active{transform:scale(.97)}
        .btn:disabled{opacity:.3;cursor:not-allowed;transform:none}

        .btn-deal{background:linear-gradient(135deg,var(--cyan),var(--magenta));color:#fff;box-shadow:0 0 25px rgba(0,240,255,.3)}
        .btn-deal:hover{box-shadow:0 0 35px rgba(0,240,255,.5)}
        .btn-hit{background:linear-gradient(135deg,var(--green),#00a040);color:#fff;box-shadow:0 0 20px rgba(0,200,80,.3)}
        .btn-stand{background:linear-gradient(135deg,var(--magenta),#cc0040);color:#fff;box-shadow:0 0 20px rgba(255,45,149,.3)}
        .btn-double{background:linear-gradient(135deg,var(--gold),#cc9900);color:#1a1a2e;box-shadow:0 0 20px rgba(255,215,0,.3)}
        .btn-clear{background:transparent;border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.4);padding:12px 20px;font-size:.6rem}
        .btn-clear:hover{border-color:var(--magenta);color:var(--magenta)}
        .btn-again{background:linear-gradient(135deg,var(--cyan),var(--violet));color:#fff;box-shadow:0 0 25px rgba(0,240,255,.3)}

        /* Insurance popup */
        .insurance-prompt{
            display:none;background:var(--glass);border:1.5px solid rgba(255,215,0,.2);
            border-radius:12px;padding:14px;text-align:center;margin:10px 0;
            backdrop-filter:blur(20px);
        }
        .insurance-prompt.show{display:block}
        .ins-text{font-size:.85rem;margin-bottom:10px}
        .ins-btns{display:flex;gap:8px;justify-content:center}
        .ins-btn{font-family:'Orbitron',sans-serif;font-size:.6rem;letter-spacing:1px;padding:10px 20px;border-radius:100px;cursor:pointer;transition:all .3s;border:1px solid}
        .ins-yes{background:rgba(255,215,0,.1);border-color:var(--gold);color:var(--gold)}
        .ins-no{background:transparent;border-color:rgba(255,255,255,.15);color:rgba(255,255,255,.4)}

        /* History */
        .history{background:var(--glass);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px;backdrop-filter:blur(20px);max-height:150px;overflow-y:auto;display:none}
        .history.show{display:block}
        .hist-title{font-family:'Orbitron',sans-serif;font-size:.5rem;letter-spacing:2px;color:rgba(255,255,255,.3);margin-bottom:6px;text-transform:uppercase}
        .hist-entry{display:flex;justify-content:space-between;padding:3px 0;font-size:.75rem;border-bottom:1px solid rgba(255,255,255,.02)}
        .hist-entry:last-child{border-bottom:none}
        .hist-win{font-family:'Orbitron',sans-serif;font-size:.65rem;font-weight:700}
        .hist-pos{color:var(--gold)}.hist-neg{color:rgba(255,255,255,.2)}.hist-push-c{color:rgba(255,255,255,.35)}

        .particle{position:fixed;border-radius:50%;pointer-events:none;z-index:101}
        .history::-webkit-scrollbar{width:4px}.history::-webkit-scrollbar-track{background:transparent}.history::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}

        @media(max-width:500px){
            h1{font-size:1.4rem}
            .card{width:58px;height:84px}
            .card-rank{font-size:1.1rem}.card-suit{font-size:1.3rem}
            .chip{width:42px;height:42px;font-size:.6rem}
            .btn{padding:12px 22px;font-size:.6rem}
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Neon Blackjack</h1>
    <div class="subtitle">霓虹21點</div>

    <div class="top-bar">
        <div class="tb-item"><div class="tb-label">籌碼</div><div class="tb-value tb-credits" id="credits">1,000</div></div>
        <div class="tb-item"><div class="tb-label">下注</div><div class="tb-value tb-bet" id="betDisplay">0</div></div>
        <div class="tb-item"><div class="tb-label">戰績</div><div class="tb-value tb-record" id="record">0-0</div></div>
    </div>

    <div class="table">
        <!-- Dealer -->
        <div class="hand-area">
            <div class="hand-label">
                <span>莊家</span>
                <span class="hand-score" id="dealerScore" style="opacity:0">0</span>
            </div>
            <div class="cards-row" id="dealerCards"></div>
        </div>

        <div class="divider"></div>

        <div class="result-msg" id="resultMsg"></div>

        <div class="divider"></div>

        <!-- Player -->
        <div class="hand-area">
            <div class="hand-label">
                <span>玩家</span>
                <span class="hand-score" id="playerScore" style="opacity:0">0</span>
            </div>
            <div class="cards-row" id="playerCards"></div>
        </div>
    </div>

    <div class="insurance-prompt" id="insPrompt">
        <div class="ins-text">莊家明牌為 A，要買保險嗎？（賭注一半）</div>
        <div class="ins-btns">
            <button class="ins-btn ins-yes" onclick="takeInsurance(true)">買保險</button>
            <button class="ins-btn ins-no" onclick="takeInsurance(false)">不要</button>
        </div>
    </div>

    <div class="controls">
        <div class="bet-phase" id="betPhase">
            <div class="chip-row">
                <span class="chip-label">下注</span>
                <div class="chip chip-10" onclick="addBet(10)">10</div>
                <div class="chip chip-50" onclick="addBet(50)">50</div>
                <div class="chip chip-100" onclick="addBet(100)">100</div>
                <div class="chip chip-500" onclick="addBet(500)">500</div>
            </div>
            <div class="btn-row">
                <button class="btn btn-deal" id="dealBtn" onclick="deal()" disabled>發牌</button>
                <button class="btn btn-clear" onclick="clearBet()">清除</button>
            </div>
        </div>

        <div class="play-phase" id="playPhase">
            <div class="btn-row">
                <button class="btn btn-hit" id="hitBtn" onclick="hit()">要牌</button>
                <button class="btn btn-stand" id="standBtn" onclick="stand()">停牌</button>
                <button class="btn btn-double" id="doubleBtn" onclick="doDouble()">加倍</button>
            </div>
        </div>

        <div class="play-phase" id="endPhase" style="display:none">
            <div class="btn-row">
                <button class="btn btn-again" onclick="newRound()">再來一局</button>
            </div>
        </div>
    </div>

    <div class="history" id="history">
        <div class="hist-title">歷史紀錄</div>
        <div id="histList"></div>
    </div>
</div>

<script>
// Audio
let aC;function ac(){if(!aC)aC=new(window.AudioContext||window.webkitAudioContext)();return aC}
function tone(f,d,t='sine',v=.06){const c=ac(),o=c.createOscillator(),g=c.createGain();o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+d);o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+d)}
function sndCard(){tone(1200,.06,'sine',.05)}
function sndChip(){tone(800,.04,'square',.04)}
function sndWin(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>tone(f,.15,'sine',.1),i*80))}
function sndBJ(){[523,659,784,1047,1319].forEach((f,i)=>setTimeout(()=>tone(f,.25,'sine',.12),i*100))}
function sndLose(){tone(200,.2,'triangle',.06)}
function sndPush(){tone(400,.1,'sine',.04)}

// Deck
const SUITS=['♠','♥','♦','♣'];
const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
let deck=[],playerHand=[],dealerHand=[];
let credits=1000,bet=0,insurance=0;
let wins=0,losses=0;
let histLog=[];
let gamePhase='bet'; // bet, play, end

function newDeck(){
    deck=[];
    for(let i=0;i<6;i++) // 6-deck shoe
        for(const s of SUITS)for(const r of RANKS)deck.push({rank:r,suit:s});
    shuffle(deck);
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
function drawCard(){if(deck.length<20)newDeck();return deck.pop()}

function cardValue(hand){
    let sum=0,aces=0;
    for(const c of hand){
        if(c.rank==='A'){aces++;sum+=11}
        else if(['K','Q','J'].includes(c.rank))sum+=10;
        else sum+=parseInt(c.rank);
    }
    while(sum>21&&aces>0){sum-=10;aces--}
    return sum;
}

function isBlackjack(hand){return hand.length===2&&cardValue(hand)===21}
function isRed(suit){return suit==='♥'||suit==='♦'}

// Render card element
function renderCard(card,faceDown=false){
    const el=document.createElement('div');
    el.className='card'+(faceDown?' face-down':'');
    const red=isRed(card.suit);
    const colorClass=red?'card-red':'card-black';
    el.innerHTML=`
        <div class="card-face">
            <div class="card-corner ${colorClass}">${card.rank}<div class="card-corner-suit">${card.suit}</div></div>
            <div class="card-rank ${colorClass}">${card.rank}</div>
            <div class="card-suit">${card.suit}</div>
        </div>
        <div class="card-back-face"><div class="card-back-pattern"></div></div>
    `;
    return el;
}

function addCardToHand(container,card,faceDown=false,delay=0){
    return new Promise(r=>{
        setTimeout(()=>{
            const el=renderCard(card,faceDown);
            container.appendChild(el);
            if(!faceDown){requestAnimationFrame(()=>el.classList.add('enter'))}
            sndCard();
            r(el);
        },delay);
    });
}

function updateScores(){
    const ps=cardValue(playerHand);
    const pEl=document.getElementById('playerScore');
    pEl.textContent=ps;pEl.style.opacity='1';
    pEl.className='hand-score'+(ps>21?' bust':'')+(isBlackjack(playerHand)?' bj':'');

    // Dealer: show only if game not in play or first card
    const dEl=document.getElementById('dealerScore');
    if(gamePhase==='play'){
        dEl.textContent=cardValue([dealerHand[0]]);
        dEl.style.opacity='1';
        dEl.className='hand-score';
    }else if(gamePhase==='end'){
        const ds=cardValue(dealerHand);
        dEl.textContent=ds;dEl.style.opacity='1';
        dEl.className='hand-score'+(ds>21?' bust':'')+(isBlackjack(dealerHand)?' bj':'');
    }
}

function updateCredits(){document.getElementById('credits').textContent=credits.toLocaleString()}
function updateBet(){document.getElementById('betDisplay').textContent=bet.toLocaleString();document.getElementById('dealBtn').disabled=bet===0}
function updateRecord(){document.getElementById('record').textContent=wins+'-'+losses}

// Bet
function addBet(amount){
    if(gamePhase!=='bet')return;
    if(credits<amount)return;
    bet+=amount;credits-=amount;
    updateCredits();updateBet();sndChip();
}
function clearBet(){
    if(gamePhase!=='bet')return;
    credits+=bet;bet=0;
    updateCredits();updateBet();
}

// Deal
async function deal(){
    if(bet===0||gamePhase!=='bet')return;
    gamePhase='play';
    document.getElementById('betPhase').style.display='none';
    document.getElementById('resultMsg').textContent='';
    document.getElementById('resultMsg').className='result-msg';
    playerHand=[];dealerHand=[];

    const dc=document.getElementById('dealerCards');
    const pc=document.getElementById('playerCards');
    dc.innerHTML='';pc.innerHTML='';

    // Deal 2 cards each
    playerHand.push(drawCard());
    await addCardToHand(pc,playerHand[0],false,0);
    dealerHand.push(drawCard());
    await addCardToHand(dc,dealerHand[0],false,300);
    playerHand.push(drawCard());
    await addCardToHand(pc,playerHand[1],false,600);
    dealerHand.push(drawCard());
    await addCardToHand(dc,dealerHand[1],true,900); // face down

    await delay(1100);
    updateScores();

    // Check for insurance (dealer shows Ace)
    if(dealerHand[0].rank==='A'){
        document.getElementById('insPrompt').classList.add('show');
        return;
    }

    // Check for blackjack
    if(isBlackjack(playerHand)){
        await revealDealer();
        if(isBlackjack(dealerHand)){endRound('push','平手',0)}
        else{endRound('blackjack','BLACKJACK!',Math.floor(bet*1.5))}
        return;
    }
    if(isBlackjack(dealerHand)){
        await revealDealer();
        endRound('lose','莊家 Blackjack',-bet);
        return;
    }

    showPlayControls();
}

function takeInsurance(yes){
    document.getElementById('insPrompt').classList.remove('show');
    if(yes){
        insurance=Math.floor(bet/2);
        credits-=insurance;updateCredits();
    }
    // Check blackjacks
    if(isBlackjack(dealerHand)){
        revealDealer().then(()=>{
            const insWin=insurance*3;
            if(isBlackjack(playerHand)){
                endRound('push','雙方 Blackjack'+(insurance?` 保險贏 +${insWin}`:''),insurance?insWin:0);
            }else{
                const net=-bet+(insurance?insWin:0);
                endRound(net>=0?'push':'lose','莊家 Blackjack'+(insurance?` 保險贏 +${insWin}`:''),net);
            }
        });
        return;
    }
    // No dealer BJ, insurance lost
    if(insurance){insurance=0}
    if(isBlackjack(playerHand)){
        revealDealer().then(()=>endRound('blackjack','BLACKJACK!',Math.floor(bet*1.5)));
        return;
    }
    showPlayControls();
}

function showPlayControls(){
    const pp=document.getElementById('playPhase');
    pp.style.display='flex';
    document.getElementById('doubleBtn').disabled=credits<bet||playerHand.length>2;
}

// Hit
async function hit(){
    if(gamePhase!=='play')return;
    document.getElementById('doubleBtn').disabled=true;
    const card=drawCard();
    playerHand.push(card);
    await addCardToHand(document.getElementById('playerCards'),card);
    await delay(300);
    updateScores();
    if(cardValue(playerHand)>21){
        await delay(300);
        await revealDealer();
        endRound('lose','爆牌！',-bet);
    }
}

// Stand
async function stand(){
    if(gamePhase!=='play')return;
    disablePlay();
    await revealDealer();
    await dealerDraw();
    resolve();
}

// Double
async function doDouble(){
    if(gamePhase!=='play'||credits<bet)return;
    credits-=bet;bet*=2;
    updateCredits();updateBet();
    disablePlay();
    const card=drawCard();
    playerHand.push(card);
    await addCardToHand(document.getElementById('playerCards'),card);
    await delay(400);
    updateScores();
    if(cardValue(playerHand)>21){
        await revealDealer();
        endRound('lose','爆牌！',-bet);
        return;
    }
    await revealDealer();
    await dealerDraw();
    resolve();
}

function disablePlay(){
    document.getElementById('hitBtn').disabled=true;
    document.getElementById('standBtn').disabled=true;
    document.getElementById('doubleBtn').disabled=true;
}

async function revealDealer(){
    const faceDown=document.querySelector('#dealerCards .card.face-down');
    if(faceDown){
        faceDown.classList.remove('face-down');
        faceDown.classList.add('reveal');
        sndCard();
        await delay(500);
    }
    gamePhase='end';
    updateScores();
}

async function dealerDraw(){
    while(cardValue(dealerHand)<17){
        const card=drawCard();
        dealerHand.push(card);
        await addCardToHand(document.getElementById('dealerCards'),card,false,0);
        await delay(500);
        updateScores();
    }
}

function resolve(){
    const ps=cardValue(playerHand),ds=cardValue(dealerHand);
    if(ds>21)endRound('win','莊家爆牌！',bet);
    else if(ps>ds)endRound('win','你贏了！',bet);
    else if(ps<ds)endRound('lose','莊家贏',-bet);
    else endRound('push','平手',0);
}

function endRound(type,msg,netWin){
    gamePhase='end';
    document.getElementById('playPhase').style.display='none';
    document.getElementById('endPhase').style.display='flex';
    updateScores();

    const rm=document.getElementById('resultMsg');
    rm.textContent=msg;
    rm.className='result-msg '+type;

    if(type==='win'||type==='blackjack'){
        const payout=type==='blackjack'?Math.floor(bet*2.5):bet*2;
        credits+=payout;
        wins++;
        if(type==='blackjack'){sndBJ();spawnParticles(25)}else{sndWin();spawnParticles(10)}
    }else if(type==='push'){
        credits+=bet;
        sndPush();
    }else{
        losses++;
        sndLose();
    }
    updateCredits();updateRecord();

    // History
    const ps=cardValue(playerHand),ds=cardValue(dealerHand);
    histLog.unshift({player:ps,dealer:ds,result:type,bet:bet});
    if(histLog.length>10)histLog.pop();
    renderHistory();

    bet=0;insurance=0;updateBet();
}

function newRound(){
    gamePhase='bet';
    document.getElementById('betPhase').style.display='flex';
    document.getElementById('playPhase').style.display='none';
    document.getElementById('endPhase').style.display='none';
    document.getElementById('hitBtn').disabled=false;
    document.getElementById('standBtn').disabled=false;
    document.getElementById('resultMsg').textContent='';
    document.getElementById('resultMsg').className='result-msg';
    document.getElementById('playerScore').style.opacity='0';
    document.getElementById('dealerScore').style.opacity='0';
    document.getElementById('dealerCards').innerHTML='';
    document.getElementById('playerCards').innerHTML='';
}

function renderHistory(){
    const el=document.getElementById('history');
    el.classList.toggle('show',histLog.length>0);
    document.getElementById('histList').innerHTML=histLog.map(h=>{
        const cls=h.result==='win'||h.result==='blackjack'?'hist-pos':h.result==='push'?'hist-push-c':'hist-neg';
        const label=h.result==='blackjack'?'BJ!':h.result==='win'?'贏':h.result==='push'?'平':'輸';
        return`<div class="hist-entry"><span>玩家${h.player} vs 莊家${h.dealer}</span><span class="hist-win ${cls}">${label}</span></div>`;
    }).join('');
}

function spawnParticles(n){
    const colors=['#00f0ff','#ff2d95','#b026ff','#ffd700','#fff'];
    for(let i=0;i<n;i++){
        setTimeout(()=>{
            const p=document.createElement('div');p.className='particle';
            p.style.left=(20+Math.random()*60)+'vw';
            p.style.top=(30+Math.random()*40)+'vh';
            p.style.width=p.style.height=(3+Math.random()*5)+'px';
            p.style.background=colors[Math.floor(Math.random()*colors.length)];
            p.style.transition=`all ${1+Math.random()}s ease-out`;
            document.body.appendChild(p);
            requestAnimationFrame(()=>{p.style.transform=`translate(${(Math.random()-.5)*200}px,${(Math.random()-.5)*200}px)`;p.style.opacity='0'});
            setTimeout(()=>p.remove(),2000);
        },i*40);
    }
}

function delay(ms){return new Promise(r=>setTimeout(r,ms))}

// Keyboard
document.addEventListener('keydown',e=>{
    if(e.code==='Space'){e.preventDefault();if(gamePhase==='bet'&&bet>0)deal();else if(gamePhase==='end')newRound()}
    if(e.key==='h'&&gamePhase==='play')hit();
    if(e.key==='s'&&gamePhase==='play')stand();
    if(e.key==='d'&&gamePhase==='play')doDouble();
});

newDeck();
</script>
</body>
</html>
